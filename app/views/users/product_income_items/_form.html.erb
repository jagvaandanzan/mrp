<style>
  .cocoon-nested-form .links a {
    float: left !important;
  }
</style>
<div class="content-wrapper">
  <section class="content">
    <div class="box box-info">
      <%= form_with model: @item, url: @item.persisted? ? users_product_income_item_path : users_product_income_items_path,
                    method: @item.persisted? ? :patch : :post, local: true, :html => {class: 'form-horizontal'} do |f| %>
        <%= form_body do %>
          <%= f.hidden_field :income_id %>

          <div class="form-group">
            <%= f.label :income_code, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 ">
              <%= f.text_field :income_code, value: @item.income.code , class: 'form-control', disabled: true %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :supply_order_item_code, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 ">
                <%= f.text_field :supply_order_item_code,
                                 value: @item.supply_order_item.present? ?  @item.supply_order_item.supply_order.code: "",
                               class: 'form-control', disabled: true %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :exchange, class: 'col-sm-3 control-label' %>
            <div class="col-sm-3 p-r-0">
                <%= f.text_field :exchange, value: @item.supply_order_item.present? ? @item.supply_order_item.supply_order.exchange_i18n : "",
                                 class: 'form-control', disabled: true %>
            </div>
            <div class="col-sm-3 ">
              <%= f.text_field :exchange_value, value: @item.supply_order_item.present? ? @item.supply_order_item.supply_order.exchange_value : "",
                               class: 'form-control', disabled: true %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :supply_order_item_id, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :supply_order_item_id) %>">
              <%= field_errors(@item, :supply_order_item_id) %>
              <%= f.grouped_collection_select :supply_order_item_id, ProductSupplyOrder.searchNotClosed(),
                                              :items, :code_with_info,
                                              :id, :product_name_with_code,
                                              {:prompt => t('controls.select.none')},
                                              {class: 'form-control selectpicker', onchange: 'supply_order_item_changed(this)',
                                               "data-live-search": "true", "data-container": ".box-info" } %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :feature_rel_id, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :feature_rel_id) %>">
              <%= field_errors(@item, :feature_rel_id) %>
              <%= f.collection_select :feature_rel_id,  ProductFeatureRel.search(@item.supply_order_item.present? ? @item.supply_order_item.product.id: nil), :id, :rel_names,
                                      {:prompt => t('controls.select.none')}, {class: 'form-control selectpicker', "data-live-search": "true"} %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :quantity, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :quantity) %>">
              <%= field_errors(@item, :quantity) %>
              <%= f.number_field :quantity, class: 'form-control', min:0, step: 1, placeholder: t('activerecord.attributes.product_income_item.quantity')  %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :price, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :price) %>">
              <%= field_errors(@item, :price) %>
              <%= f.number_field :price, class: 'form-control', min:0, step: 0.01, placeholder: t('activerecord.attributes.product_income_item.price')  %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :shuudan, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :shuudan) %>">
              <%= field_errors(@item, :shuudan) %>
              <%= f.number_field :shuudan, class: 'form-control', min:0, step: 0.1, placeholder: t('activerecord.attributes.product_income_item.shuudan')  %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :urgent_type, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :urgent_type) %>">
              <%= field_errors(@item, :urgent_type) %>
              <%= f.select :urgent_type, ProductIncomeItem.urgent_types_i18n.keys.map {|k| [ProductIncomeItem.urgent_types_i18n[k], k]}, {:prompt => t('controls.select.none')}, {class: 'form-control'} %>
            </div>
          </div>

          <div class="form-group">
            <%= f.label :note, class: 'col-sm-3 control-label' %>
            <div class="col-sm-6 <%= get_error_class(@item, :note) %>">
              <%= field_errors(@item, :note) %>
              <%= f.text_area :note, class: 'form-control', placeholder: t('activerecord.attributes.product_income_item.note') %>
            </div>
          </div>

          <div class="form-group">
            <div class="cocoon-nested-form">
              <%= f.label :income_locations, class: 'col-sm-3 control-label' %>
              <div class="col-sm-8 <%= get_error_class(@item, :income_locations) %>">
                <%= field_errors(@item, :income_locations) %>
                <table class="table table-bordered" id="tb_income_locations">
                  <tr>
                    <th ><%= t('activerecord.attributes.product_income_item.location_id') %></th>
                    <th ><%= t('activerecord.attributes.product_income_item.quantity') %></th>
                    <th width="50px"></th>
                  </tr>
                  <%= f.fields_for :income_locations do |m| %>
                    <%= render 'income_location_fields', :f => m %>
                  <% end %>
                </table>
              </div>
              <div class="links col-sm-1 pull-left">
                <%= link_to_add_association f, :income_locations, data: {association_insertion_node: '#tb_income_locations', association_insertion_method: :append} do %>
                  <%= nested_add_btn %>
                <% end %>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <%= f.submit t('controls.button.save'), class: 'btn btn-warning' %>
            <%= link_to t('titles.back_to_list'), users_product_income_items_path(page: cookies[:page_number], income_id: @item.income.id), {class: "btn blck-btn"} %>
          </div>
        <% end %>
      <% end %>
    </div>
  </section>
</div>


<script>
    $(document).ready(function() {
        $('.selectpicker').selectpicker('refresh');
    });

    function supply_order_item_changed(select){
        // alert($(select).val());
        // zahialgiin kod, exchange, exchange_value
        var val = $(select).val();
        if(val!="" && val!=undefined && val!=null) {
            Rails.ajax({
                url: "<%= get_supply_order_info_users_product_income_items_path %>",
                type: "PATCH",
                data: "order_item_id=" + val,
                success: function (data) {
                    if (data!=undefined) {
                        $("#product_income_item_supply_order_item_code").val(data.order_code);
                        $("#product_income_item_exchange").val(data.exchange);
                        $("#product_income_item_exchange_value").val(data.exchange_value);

                        var features = data.features;
                        var feature_select = "";
                        for (var i = 0; i < features.length; i++) {
                            feature_select += '<option value="' + features[i]["id"] + '">' + features[i]["name"] + '</option>';
                        }
                        $("#product_income_item_feature_rel_id")
                            .html("<option>Сонгох</option>" + feature_select)
                            .selectpicker('refresh');
                    }
                },
                error: function (data) {
                    console.log(data);
                }
            }); // end ajax
        }
    }

    function callLocChildren(select){
        var val = null;
        if(select != undefined && select != null) {
            val = $(select).val();
            if(val!="" && val!=undefined && val!=null) {
                $("input#product_income_item_location_id").val(val);

                Rails.ajax({
                    url: "<%= get_location_children_users_product_income_items_path %>",
                    type: "PATCH",
                    data: "parent_id=" + val,
                    success: function (data) {
                        var childrens = data.childrens;
                        if (childrens!=undefined && childrens.length > 0) {
                            $(select).prop("disabled", true);

                            var divSelect = "<div class=\"col-sm-12 product-location\" style='padding: 0; padding-top: 10px;' > " +
                                "<select name='sub_location_id' class='form-control' onchange='callLocChildren(this)'>" +
                                "<option value=''>Дэд ангилал сонгох</option>";

                            for (var i = 0; i < childrens.length; i++) {
                                divSelect += '<option value="' + childrens[i]["id"] + '">' + childrens[i]["name"] + '</option>';
                            }
                            divSelect += "</select>" + "</div>";

                            $("#div_product_location").append(divSelect);
                        }
                    },
                    error: function (data) {
                        console.log(data);
                    }
                }); // end ajax
            } // val is undefined chek
        }// select is undefined check
    }

    function clearLocation() {
        $("#mainLocId")
            .prop("disabled", false)
            .val("");

        $(".product-location").each(function () {
            $(this).remove();
        })
    }

</script>