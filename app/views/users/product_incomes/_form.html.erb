<% content_for :stylesheets do -%>
  <%= stylesheet_link_tag "form" %>
<% end %>
<div class="content-wrapper">
  <section class="content">
    <div class="box box-info">
      <%= form_with model: @product_income, url: @product_income.persisted? ? users_product_income_path : users_product_incomes_path,
                    method: @product_income.persisted? ? :patch : :post, local: true, :html => {class: 'form-horizontal'} do |f| %>
        <%= form_body do %>
          <%= f.hidden_field :shipping_ub_id %>
          <div class="col-md-12">
            <div class="row">
              <div class="col-md-3 field_div">
                <%= f.label :number, class: 'control-label' %>
                <div>
                  <%= text_field_tag :number, show_id(@product_income.persisted? ? @product_income.id : @product_income.number), {class: 'form-control', readonly: true} %>
                </div>
              </div>
              <div class="col-md-3 field_div">
                <%= f.label :income_date, class: 'control-label' %>
                <div class="input-append input-group date <%= get_error_class(@product_income, :income_date) %>" data-provide="datepicker">
                  <%= field_errors(@product_income, :income_date) %>
                  <%= f.text_field :income_date, value: @product_income.income_date.strftime('%F'), class: 'field form-control', placeholder: t('activerecord.attributes.product_income.income_date') %>
                  <div class="input-group-addon">
                    <i class="fa fa-calendar"></i>
                  </div>
                </div>
              </div>
              <div class="col-md-3 field_div">
                <%= f.label :logistic_id, class: 'control-label' %>
                <div class="<%= get_error_class(@product_income, :logistic_id) %>">
                  <%= field_errors(@product_income, :logistic_id) %>
                  <%= f.collection_select :logistic_id, Logistic.all, :id, :name, {}, {class: 'form-control'} %>
                </div>
              </div>
              <div class="col-md-3 field_div">
                <%= f.label :cargo_price, class: 'control-label' %>
                <div class="<%= get_error_class(@product_income, :cargo_price) %>">
                  <%= field_errors(@product_income, :cargo_price) %>
                  <%= f.number_field :cargo_price, step: 1, class: 'form-control', placeholder: t('activerecord.attributes.product_income.cargo_price') %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-12 field_div m-t-10">
            <div class="cocoon-nested-form">
              <div class="<%= get_error_class(@product_income, :product_income_products) %>">
                <%= field_errors(@product_income, :product_income_products) %>
                <table class="table table-bordered" id="tb_product_income_products">
                  <tr>
                    <th colspan="5" class="text-center"><%= t('activerecord.attributes.product_income.product_income_products') %></th>
                    <th colspan="1" class="text-center"><%= t('activerecord.attributes.product_income_item.loaded') %></th>
                    <th colspan="2" class="text-center"><%= t('titles.received') %></th>
                    <th width="50px"></th>
                  </tr>
                  <tr>
                    <th class="va-mid"><%= t('activerecord.attributes.fb_post.product_code') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.fb_post.product_name') %></th>
                    <th class="va-mid"><%= t('activerecord.models.product_feature') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.product_supply_order.product_image') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.product_supply_order_item.shipping_ub_date') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.product_income_item.quantity') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.product_income_item.quantity') %></th>
                    <th class="va-mid"><%= t('activerecord.attributes.product_income_item.cargo') %></th>
                    <th></th>
                  </tr>
                  <%= f.fields_for :product_income_products do |m| %>
                    <%= render 'product_income_product_fields', :f => m %>
                  <% end %>
                </table>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <%= f.submit t('controls.button.save'), class: 'btn btn-warning' %>
          </div>

          <div class="col-md-12 field_div cocoon-nested-form">
            <table class="table table-bordered" id="tb_shipping_ub_products">
              <tr>
                <th class="va-mid">Баримтын дугаар</th>
                <th class="va-mid"><%= t('activerecord.attributes.fb_post.product_code') %></th>
                <th class="va-mid"><%= t('activerecord.attributes.fb_post.product_name') %></th>
                <th class="va-mid"><%= t('activerecord.models.product_feature') %></th>
                <th class="va-mid"><%= t('activerecord.attributes.product_supply_order.product_image') %></th>
                <th class="va-mid"><%= t('activerecord.attributes.product_supply_order_item.shipping_ub_date') %></th>
                <th class="va-mid"><%= t('titles.box') %></th>
                <th class="va-mid"><%= t('activerecord.attributes.product_income_item.loaded') %></th>
                <th class="va-mid"><%= t('titles.cargo') %></th>
                <th width="50px"></th>
              </tr>
              <% box_id = 0
                 shipping_ub_products = ShippingUbProduct.find_to_incomes
                 box_id_array = shipping_ub_products.map(&:shipping_ub_box_id).to_a
                 box_ids = box_id_array.group_by(&:itself).transform_values(&:count)#tally
                 shipping_ub_products.each do |ub_product| %>
                <% shipping_ub = ub_product.shipping_ub
                   product = ub_product.product
                   shipping_ub_box = ub_product.shipping_ub_box
                   b_id = shipping_ub_box.id
                   box_products = box_ids[b_id] %>
                <tr class="p-<%= ub_product.id %>">
                  <td class="va-mid"><%= show_id(shipping_ub.id) %></td>
                  <td class="va-mid"><%= product.code %></td>
                  <td class="va-mid"><%= product.full_name %></td>
                  <td><%= ub_product.shipping_ub_features.by_quantity(0).count %></td>
                  <td class="va-mid">
                    <% if product.picture.present? %>
                      <%= link_to product.picture.url, :"data-lightbox" => "roadtrip" do %>
                        <%= t('titles.view') %>
                      <% end %>
                    <% end %>
                  </td>
                  <td class="va-mid"><%= shipping_ub.date.strftime('%F') %></td>
                  <td class="va-mid"><%= box_products > 1 ? 'Тийм' : '' %></td>
                  <td class="va-mid text-center"><%= ub_product[:remainder] %></td>
                  <% if box_id != b_id
                       box_id = b_id %>
                    <td class="va-mid" rowspan="<%= box_products %>"><%= box_products != 1 ? '1' : '' %></td>
                  <% end %>
                  <td class="va-mid">
                    <button class="btn btn-block btn-success btn-xs" type="button" onclick="add_product(<%= ub_product.id %>)">
                      <i class="fa fa-plus" style="color: white"></i></button>
                  </td>
                </tr>
              <% end %>
            </table>
          </div>
        <% end %>
      <% end %>
    </div>
  </section>
</div>
<script>
    function add_product(id) {
        let row = $('#tb_product_income_products .nested-fields').length;
        Rails.ajax({
            url: "<%= insert_shipping_ub_users_product_incomes_path %>",
            type: "PATCH",
            data: "id=" + id + "&rows=" + row,
            success: function () {
                $('#tb_shipping_ub_products tr.p-' + id).each(function () {
                    $(this).remove();
                });
            },
        });
    }
</script>