<% content_for :stylesheets do -%>
  <%= stylesheet_link_tag "search" %>
  <%= stylesheet_link_tag "list" %>
<% end %>
<style>
  #tb_calculated tr td {
    text-align: center;
  }

  #tb_calculated tr td:first-child {
    text-align: left;
  }
</style>
<div class="content-wrapper">

  <div class="col-md-12 m-t-10 m-b-10">
    <%= form_with url: users_supply_calculations_supply_orders_path, method: "get", class: "", local: true do |f| %>
      <div class="col-md-3 search">
        <div id="search-date" class="form-control search">
          <i class="fa fa-calendar fa-lg p-r-0"></i>
          <span><%= t("filters.by_date") %>...</span>
          <%= f.hidden_field :by_start, value: @by_start %>
          <%= f.hidden_field :by_end, value: @by_end %>
        </div>
      </div>

      <div class="col-md-1 search">
        <%= submit_tag t('controls.button.searching'), :class => 'btn blck-btn pull-left', style: 'height: 30px; font-size: smaller !important' %>
      </div>
      <div class="col-md-2 search">
        <%= link_to 'Падаанаар', users_supply_calculations_for_invoice_path(by_start: @by_start, by_end: @by_end), target: '_blank', class: 'btn blck-btn pull-right' %>
      </div>
    <% end %>
  </div>

  <section class="content container-fluid">
    <div class="row">
      <div class="col-xs-7">
        <div class="box" id="div_list">
          <div class="box-body table-responsive no-padding">
            <%= render 'layouts/flash_message' %>
            <table class="table table-bordered" id="tb_calculated">
              <thead>
              <tr>
                <th rowspan="2" class="va-mid"><%= @by_start %> - <%= @by_end %></th>
                <th rowspan="2" class="va-mid">Маркет.мн</th>
                <th colspan="2" class="text-center">Далай ложистик</th>
              </tr>
              <tr>
                <th class="text-center">Нийлээгүй</th>
                <th class="text-center">Нийлсэн</th>
                <th class="text-center">Нийт</th>
              </tr>
              </thead>
              <tbody>
              <% bank_transaction = BankTransaction.by_billing_date(@by_start, @by_end).by_dalai
                 prev_transaction = BankTransaction.by_before_start(@by_start).by_dalai.sum(:exc_summary)
                 prev_logistic = LogisticBalance.by_before_start(@by_start).sum_price %>
              <tr>
                <td>Өмнөх үлдэгдэл</td>
                <td><%= get_currency(prev_logistic - prev_transaction, Const::CURRENCY[0], 2) %></td>
                <td colspan="2"><%= get_currency(prev_transaction - prev_logistic, Const::CURRENCY[0], 2) %></td>
                <td></td>
              </tr>
              <tr>
                <td>Орлого</td>
                <td>-<%= get_currency_mn bank_transaction.sum(:summary) %></td>
                <td colspan="2"><%= get_currency(bank_transaction.sum(:exc_summary), Const::CURRENCY[0], 2) %></td>
                <td></td>
              </tr>
              <% income_products = ProductIncomeProduct.by_date(@by_start, @by_end) %>
              <% income_items = ProductIncomeItem.by_income_date(@by_start, @by_end) %>
              <% sum_supply_feature_cost_n = income_items.by_calc_nil("true").sum_supply_feature_cost
                 sum_supply_feature_cost_c = income_items.by_calc_nil("false").sum_supply_feature_cost
                 sum_shipping_er_cost_n = income_items.by_calc_nil("true").sum_shipping_er_cost
                 sum_shipping_er_cost_c = income_items.by_calc_nil("false").sum_shipping_er_cost
                 sum_shipping_ub_n = income_items.by_calc_nil("true").sum_shipping_ub_product_cost + income_items.by_calc_nil("true").sum_shipping_ub_sample_cost
                 sum_shipping_ub_c = income_items.by_calc_nil("false").sum_shipping_ub_product_cost + income_items.by_calc_nil("false").sum_shipping_ub_sample_cost %>
              <tr>
                <td>Худалдан авалт</td>
                <td></td>
                <td><%= get_currency(sum_supply_feature_cost_n, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_supply_feature_cost_c, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_supply_feature_cost_n + sum_supply_feature_cost_c, Const::CURRENCY[0], 2) %></td>
              </tr>
              <tr>
                <td>Эрээнд хүлээн авсан</td>
                <td></td>
                <td><%= get_currency(sum_shipping_er_cost_n, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_shipping_er_cost_c, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_shipping_er_cost_n + sum_shipping_er_cost_c, Const::CURRENCY[0], 2) %></td>
              </tr>
              <tr>
                <td>Эрээнээс УБ-луу</td>
                <td></td>
                <td><%= get_currency(sum_shipping_ub_n, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_shipping_ub_c, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(sum_shipping_ub_n + sum_shipping_ub_c, Const::CURRENCY[0], 2) %></td>
              </tr>
              <tr>
                <td>Нийт</td>
                <td></td>
                <% s_n = sum_supply_feature_cost_n + sum_shipping_er_cost_n + sum_shipping_ub_n
                   s_c = sum_supply_feature_cost_c + sum_shipping_er_cost_c + sum_shipping_ub_c %>
                <td><%= get_currency(s_n, Const::CURRENCY[0], 2) %></td>
                <td><%= get_currency(s_c, Const::CURRENCY[0], 2) %></td>
                <td class="text-bold"><%= get_currency(s_n + s_c, Const::CURRENCY[0], 2) %></td>
              </tr>
              <tr>
                <td>Тодруулах/ Түгжигдсэн</td>
                <td></td>
                <td colspan="2"><%= income_items.by_clarify(true).count %></td>
                <td></td>
              </tr>
              <tr>
                <td>Бараа</td>
                <td></td>
                <td><%= link_to income_products.by_calc_nil("true").count, users_supply_calculations_income_products_path(by_start: @by_start, by_end: @by_end, by_nil: true), target: '_blank' %></td>
                <td><%= link_to income_products.by_calc_nil("false").count, users_supply_calculations_income_products_path(by_start: @by_start, by_end: @by_end, by_nil: false), target: '_blank' %></td>
                <td></td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </section>
</div>
<%= render 'shared/date-range', search_field_id: 'search-date', start_id: 'by_start', finish_id: 'by_end' %>